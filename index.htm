<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­èª²å ‚æ¶ç­”ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .buzzer-btn { transition: all 0.1s ease-in-out; }
        .buzzer-btn:active:not(:disabled) { transform: scale(0.95); }
        .hidden { display: none !important; }
        /* é¿å…è¡Œå‹•è£ç½®é¸å–æ–‡å­—å¹²æ“¾æ“ä½œ */
        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body class="h-screen w-screen overflow-x-hidden flex flex-col no-select">

    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <h1 class="text-xl font-bold">èª²å ‚äº’å‹•æ¶ç­”ç³»çµ±</h1>
        <div id="userInfo" class="text-sm">è¼‰å…¥ä¸­...</div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow relative overflow-y-auto p-4 flex flex-col items-center">
        
        <!-- ç•«é¢ 1ï¼šé¦–é  (é¸æ“‡è§’è‰²) -->
        <section id="view-home" class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mt-10 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">è«‹é¸æ“‡æ‚¨çš„èº«ä»½</h2>

            <!-- éŒ¯èª¤æç¤ºå€å¡Š (é è¨­éš±è—) -->
            <div id="auth-error-message" class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 text-left rounded shadow-sm">
                <h3 class="text-red-800 font-bold flex items-center">
                    <span class="mr-2">âš ï¸</span> Firebase è¨­å®šéŒ¯èª¤
                </h3>
                <p class="text-red-700 text-sm mt-2">ç³»çµ±åµæ¸¬åˆ°æ‚¨çš„ Firebase å°šæœªå•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€åŠŸèƒ½ï¼Œè«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿä¿®å¾©ï¼š</p>
                <ol class="list-decimal ml-5 mt-2 text-sm text-red-700 space-y-1">
                    <li>å‰å¾€ Firebase æ§åˆ¶å° (Firebase Console)</li>
                    <li>é€²å…¥å°ˆæ¡ˆ <strong>buzz-in-aa336</strong></li>
                    <li>é»é¸å·¦å´é¸å–®çš„ <strong>Authentication</strong> (é©—è­‰)</li>
                    <li>åˆ‡æ›åˆ° <strong>Sign-in method</strong> (ç™»å…¥æ–¹å¼) é ç±¤</li>
                    <li>æ‰¾åˆ° <strong>åŒ¿å (Anonymous)</strong>ï¼Œå°‡å…¶ç‹€æ…‹è¨­ç‚ºã€Œå•Ÿç”¨ã€ä¸¦å„²å­˜</li>
                    <li>é‡æ–°æ•´ç†æ­¤ç¶²é </li>
                </ol>
            </div>

            <div class="space-y-4">
                <button onclick="app.showView('view-host-setup')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow">
                    ğŸ‘©â€ğŸ« æˆ‘æ˜¯è€å¸« (å»ºç«‹å ´æ¬¡)
                </button>
                <button onclick="app.showView('view-student-join')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow">
                    ğŸ™‹â€â™‚ï¸ æˆ‘æ˜¯å­¸ç”Ÿ (åŠ å…¥æ¶ç­”)
                </button>
                <button onclick="app.showView('view-display-join')" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow">
                    ğŸ“º é–‹å•Ÿå±•ç¤ºå¤§è¢å¹•
                </button>
            </div>
        </section>

        <!-- ç•«é¢ 2ï¼šè€å¸«å»ºç«‹å ´æ¬¡ -->
        <section id="view-host-setup" class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mt-10 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">å»ºç«‹æ–°æ¶ç­”å ´æ¬¡</h2>
            <p class="text-gray-600 mb-6">ç³»çµ±å°‡ç”¢ç”Ÿä¸€çµ„ä»£ç¢¼ä¾›å­¸ç”ŸåŠ å…¥ã€‚</p>
            <button onclick="app.createSession()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow mb-4">
                ç«‹å³å»ºç«‹å ´æ¬¡
            </button>
            <button onclick="app.showView('view-home')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">
                è¿”å›
            </button>
        </section>

        <!-- ç•«é¢ 3ï¼šå­¸ç”ŸåŠ å…¥ -->
        <section id="view-student-join" class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mt-10 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">åŠ å…¥æ¶ç­”å ´æ¬¡</h2>
            <input type="text" id="join-session-code" placeholder="è«‹è¼¸å…¥ 6 ç¢¼å ´æ¬¡ä»£ç¢¼" class="w-full border-2 border-gray-300 p-3 rounded-lg mb-4 text-center text-xl uppercase" maxlength="6">
            <input type="text" id="join-student-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åæˆ–åº§è™Ÿ" class="w-full border-2 border-gray-300 p-3 rounded-lg mb-6 text-center text-xl">
            <button onclick="app.joinAsStudent()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow mb-4">
                é€²å…¥æ¶ç­”
            </button>
            <button onclick="app.showView('view-home')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">
                è¿”å›
            </button>
        </section>

        <!-- ç•«é¢ 4ï¼šå¤§è¢å¹•åŠ å…¥ -->
        <section id="view-display-join" class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 mt-10 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">é–‹å•Ÿå±•ç¤ºå¤§è¢å¹•</h2>
            <input type="text" id="display-session-code" placeholder="è«‹è¼¸å…¥ 6 ç¢¼å ´æ¬¡ä»£ç¢¼" class="w-full border-2 border-gray-300 p-3 rounded-lg mb-6 text-center text-xl uppercase" maxlength="6">
            <button onclick="app.joinAsDisplay()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow mb-4">
                é–‹å§‹æŠ•å½±
            </button>
            <button onclick="app.showView('view-home')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">
                è¿”å›
            </button>
        </section>

        <!-- ç•«é¢ 5ï¼šè€å¸«æ§åˆ¶å° -->
        <section id="view-host-dashboard" class="w-full max-w-4xl hidden flex-col md:flex-row gap-6">
            <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
            <div class="w-full md:w-1/3 bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">å ´æ¬¡è³‡è¨Š</h2>
                <div class="bg-blue-100 text-blue-800 text-3xl font-mono text-center py-4 rounded-lg mb-4 font-bold tracking-widest" id="host-code-display">------</div>
                
                <div id="qrcode-container" class="flex justify-center mb-6 p-2 bg-white rounded"></div>

                <hr class="my-4">
                <h3 class="font-bold text-gray-700 mb-3">å…¨å±€æ§åˆ¶</h3>
                <div class="space-y-3">
                    <button onclick="app.resetBuzzer()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded shadow">
                        ğŸ”„ é‡ç½®æ¶ç­”ç‡ˆ (é‡æ–°é–‹å§‹)
                    </button>
                    <button id="btn-toggle-lock" onclick="app.toggleGlobalLock()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded shadow">
                        ğŸ”’ æš«åœæ‰€æœ‰æ¶ç­”
                    </button>
                </div>
            </div>

            <!-- å³å´å­¸ç”Ÿåˆ—è¡¨ -->
            <div class="w-full md:w-2/3 bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">åƒè³½è€…åå–® & è¨˜åˆ†æ¿</h2>
                    <span id="host-status-badge" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold">é–‹æ”¾æ¶ç­”ä¸­</span>
                </div>
                
                <div id="host-winner-alert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded shadow-sm">
                    <p class="font-bold text-lg">ğŸ‰ æ¶ç­”æˆåŠŸï¼š<span id="host-winner-name">---</span></p>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†æ•¸</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="host-participants-list" class="bg-white divide-y divide-gray-200">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ç•«é¢ 6ï¼šå­¸ç”Ÿæ¶ç­”å™¨ -->
        <section id="view-student-buzzer" class="w-full max-w-md hidden flex-col items-center justify-center h-full pt-10">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800" id="student-display-name">åƒè³½è€…å§“å</h2>
                <p class="text-gray-500">ç›®å‰åˆ†æ•¸ï¼š<span id="student-score" class="font-bold text-blue-600 text-xl">0</span></p>
            </div>

            <!-- å¤§æŒ‰éˆ• -->
            <button id="main-buzzer-btn" onclick="app.buzzIn()" disabled
                class="buzzer-btn w-64 h-64 rounded-full text-white text-4xl font-bold shadow-[0_10px_0_rgb(185,28,28)] active:shadow-[0_0px_0_rgb(185,28,28)] active:translate-y-2 flex items-center justify-center mx-auto bg-gray-400 cursor-not-allowed">
                ç­‰å¾…ä¸­
            </button>

            <div id="student-status-msg" class="mt-10 text-xl font-bold text-center text-gray-600">
                è«‹ç­‰å¾…è€å¸«é–‹æ”¾æ¶ç­”
            </div>
        </section>

        <!-- ç•«é¢ 7ï¼šå¤§è¢å¹•å±•ç¤º -->
        <section id="view-display-screen" class="w-full max-w-6xl hidden flex-col h-full">
            <div class="text-center mb-8 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-4xl font-bold text-gray-800">è«‹åŠ å…¥å ´æ¬¡ä»£ç¢¼ï¼š<span id="display-room-code" class="text-blue-600 tracking-widest font-mono">------</span></h2>
            </div>
            
            <!-- æ¶ç­”æˆåŠŸå¼·çƒˆæç¤º -->
            <div id="display-winner-banner" class="hidden mb-8 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 text-white p-10 rounded-2xl shadow-2xl text-center transform transition-all scale-105 border-4 border-yellow-300">
                <h1 class="text-6xl font-extrabold mb-4 drop-shadow-lg">âš¡ æ¶ç­”æˆåŠŸ âš¡</h1>
                <p class="text-5xl font-bold drop-shadow-md" id="display-winner-name">ç‹å°æ˜</p>
            </div>

            <!-- åˆ†æ•¸ç¶²æ ¼ -->
            <div id="display-participants-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </section>

    </main>

    <!-- è¨Šæ¯æç¤ºæ¡†çµ„ä»¶ -->
    <div id="toast-container" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æ‚¨çš„å°ˆå±¬ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyB2f-W4rWXsAql4bWKUStzadeAaHZVcY7o",
            authDomain: "buzz-in-aa336.firebaseapp.com",
            projectId: "buzz-in-aa336",
            storageBucket: "buzz-in-aa336.firebasestorage.app",
            messagingSenderId: "789141653243",
            appId: "1:789141653243:web:28fdd18717993ae49bd25e"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'buzz-in-app';
        
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // å…¨å±€æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        const state = {
            user: null,
            sessionId: null,
            participantId: null, // å­¸ç”Ÿå°ˆç”¨
            participants: [],    // è¨˜æ†¶é«”å…§ç·©å­˜çš„åƒè³½è€…è³‡æ–™
            sessionData: null,   // è¨˜æ†¶é«”å…§ç·©å­˜çš„å ´æ¬¡è³‡æ–™
            unsubSession: null,
            unsubParticipants: null
        };

        // --- æ ¸å¿ƒå…±ç”¨åŠŸèƒ½ ---

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-full shadow-lg font-bold text-center transition-opacity duration-500 opacity-100`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('opacity-100', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function showView(viewId) {
            const views = ['view-home', 'view-host-setup', 'view-student-join', 'view-display-join', 'view-host-dashboard', 'view-student-buzzer', 'view-display-screen'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === viewId) {
                        el.classList.remove('hidden');
                        if (id === 'view-host-dashboard' || id === 'view-student-buzzer' || id === 'view-display-screen') {
                            el.classList.add('flex'); // ç¢ºä¿ flexbox ä½ˆå±€æ­£ç¢º
                        }
                    } else {
                        el.classList.add('hidden');
                        el.classList.remove('flex');
                    }
                }
            });
        }

        function generateShortCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // æ’é™¤æ˜“æ··æ·†å­—å…ƒ I, O, 1, 0
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function getPublicSessionRef(sessionId) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId);
        }

        function getParticipantsCollectionRef(sessionId) {
            return collection(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId, 'participants');
        }

        function getParticipantDocRef(sessionId, uid) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId, 'participants', uid);
        }

        // --- è€å¸« (ä¸»æ§ç«¯) åŠŸèƒ½ ---

        async function createSession() {
            if (!state.user) return showToast('å°šæœªå®Œæˆé©—è­‰ï¼Œè«‹ç¨å€™', 'error');
            
            const newCode = generateShortCode();
            state.sessionId = newCode;
            
            try {
                const sessionRef = getPublicSessionRef(newCode);
                await setDoc(sessionRef, {
                    hostId: state.user.uid,
                    isLocked: true,
                    winnerUid: null,
                    createdAt: serverTimestamp()
                });
                
                showToast(`å ´æ¬¡ ${newCode} å»ºç«‹æˆåŠŸï¼`, 'success');
                initHostDashboard();
            } catch (error) {
                console.error("Create session error:", error);
                showToast('å»ºç«‹å ´æ¬¡å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase è³‡æ–™åº«æ¬Šé™', 'error');
            }
        }

        function initHostDashboard() {
            showView('view-host-dashboard');
            document.getElementById('host-code-display').innerText = state.sessionId;
            
            // ç”¢ç”Ÿ QRCode
            document.getElementById('qrcode-container').innerHTML = ''; 
            const joinUrl = `${window.location.href.split('?')[0]}?code=${state.sessionId}`;
            new QRCode(document.getElementById("qrcode-container"), {
                text: joinUrl,
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });

            startSessionListeners('host');
        }

        async function toggleGlobalLock() {
            if (!state.sessionId || !state.sessionData) return;
            const sessionRef = getPublicSessionRef(state.sessionId);
            const newState = !state.sessionData.isLocked;
            try {
                await updateDoc(sessionRef, { isLocked: newState });
            } catch (error) {
                console.error("Update lock error", error);
            }
        }

        async function resetBuzzer() {
            if (!state.sessionId) return;
            const sessionRef = getPublicSessionRef(state.sessionId);
            try {
                await updateDoc(sessionRef, { winnerUid: null, isLocked: false });
                showToast('æ¶ç­”ç‡ˆå·²é‡ç½®', 'success');
            } catch (error) {
                console.error("Reset buzzer error", error);
            }
        }

        async function adjustScore(uid, amount) {
            if (!state.sessionId) return;
            const partRef = getParticipantDocRef(state.sessionId, uid);
            try {
                await updateDoc(partRef, { score: increment(amount) });
            } catch (error) {
                console.error("Adjust score error", error);
                showToast('èª¿æ•´åˆ†æ•¸å¤±æ•—', 'error');
            }
        }

        async function toggleParticipantLock(uid, currentLockState) {
            if (!state.sessionId) return;
            const partRef = getParticipantDocRef(state.sessionId, uid);
            try {
                await updateDoc(partRef, { isIndividualLocked: !currentLockState });
            } catch (error) {
                console.error("Individual lock error", error);
            }
        }

        function renderHostParticipants() {
            const tbody = document.getElementById('host-participants-list');
            tbody.innerHTML = '';
            
            const sortedParticipants = [...state.participants].sort((a, b) => b.score - a.score);

            sortedParticipants.forEach(p => {
                const tr = document.createElement('tr');
                const isWinner = state.sessionData?.winnerUid === p.uid;
                
                let statusHtml = p.isIndividualLocked 
                    ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">å·²ç¦è¨€</span>`
                    : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">æ­£å¸¸</span>`;
                
                if (isWinner) {
                    statusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 animate-pulse">âš¡ æ¶ç­”æˆåŠŸ</span>`;
                }

                tr.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">${statusHtml}</td>
                    <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">${p.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center text-xl font-bold text-blue-600">${p.score}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="app.adjustScore('${p.uid}', 1)" class="text-green-600 hover:text-green-900 bg-green-50 px-2 py-1 rounded mr-2">+1åˆ†</button>
                        <button onclick="app.adjustScore('${p.uid}', -1)" class="text-red-600 hover:text-red-900 bg-red-50 px-2 py-1 rounded mr-2">-1åˆ†</button>
                        <button onclick="app.toggleParticipantLock('${p.uid}', ${p.isIndividualLocked})" class="text-gray-600 hover:text-gray-900 bg-gray-100 px-2 py-1 rounded">
                            ${p.isIndividualLocked ? 'è§£é–' : 'ç¦ç”¨'}
                        </button>
                    </td>
                `;
                if(isWinner) tr.classList.add('bg-yellow-50');
                tbody.appendChild(tr);
            });
        }

        // --- å­¸ç”Ÿ (åƒè³½ç«¯) åŠŸèƒ½ ---

        async function joinAsStudent() {
            const codeInput = document.getElementById('join-session-code').value.trim().toUpperCase();
            const nameInput = document.getElementById('join-student-name').value.trim();

            if (codeInput.length !== 6 || !nameInput) {
                return showToast('è«‹å¡«å¯«å®Œæ•´ä»£ç¢¼èˆ‡å§“å', 'warning');
            }

            if (!state.user) return showToast('å°šæœªå®Œæˆé©—è­‰', 'error');

            const sessionRef = getPublicSessionRef(codeInput);
            try {
                const docSnap = await getDoc(sessionRef);
                if (!docSnap.exists()) {
                    return showToast('æ‰¾ä¸åˆ°è©²å ´æ¬¡ï¼Œè«‹ç¢ºèªä»£ç¢¼', 'error');
                }

                state.sessionId = codeInput;
                state.participantId = state.user.uid;

                const partRef = getParticipantDocRef(state.sessionId, state.participantId);
                await setDoc(partRef, {
                    uid: state.participantId,
                    name: nameInput,
                    score: 0,
                    isIndividualLocked: false,
                    joinedAt: serverTimestamp()
                }, { merge: true });

                showToast('æˆåŠŸåŠ å…¥ï¼', 'success');
                initStudentBuzzer(nameInput);
            } catch (error) {
                console.error("Join error", error);
                showToast('åŠ å…¥å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
            }
        }

        function initStudentBuzzer(name) {
            showView('view-student-buzzer');
            document.getElementById('student-display-name').innerText = name;
            startSessionListeners('student');
        }

        async function buzzIn() {
            if (!state.sessionId || !state.participantId || !state.sessionData) return;
            
            const myData = state.participants.find(p => p.uid === state.participantId);
            if (state.sessionData.isLocked || state.sessionData.winnerUid || (myData && myData.isIndividualLocked)) {
                return;
            }

            const sessionRef = getPublicSessionRef(state.sessionId);
            try {
                await updateDoc(sessionRef, {
                    winnerUid: state.participantId,
                    isLocked: true 
                });
                navigator.vibrate && navigator.vibrate(200); 
            } catch (error) {
                console.error("Buzz in error", error);
            }
        }

        function updateStudentUI() {
            if (!state.sessionData || !state.participantId) return;

            const btn = document.getElementById('main-buzzer-btn');
            const msg = document.getElementById('student-status-msg');
            const scoreDisplay = document.getElementById('student-score');
            
            const myData = state.participants.find(p => p.uid === state.participantId);
            if (myData) {
                scoreDisplay.innerText = myData.score;
            }

            const isGlobalLocked = state.sessionData.isLocked;
            const winnerUid = state.sessionData.winnerUid;
            const isIndividuallyLocked = myData?.isIndividualLocked;

            if (winnerUid === state.participantId) {
                btn.className = "buzzer-btn w-64 h-64 rounded-full text-white text-4xl font-bold mx-auto flex items-center justify-center shadow-[0_10px_0_rgb(202,138,4)] active:translate-y-2 bg-yellow-500 cursor-default ring-8 ring-yellow-300 animate-pulse";
                btn.innerText = "âš¡ æˆåŠŸ âš¡";
                btn.disabled = true;
                msg.innerText = "å¤ªæ£’äº†ï¼æ‚¨æ¶åˆ°äº†ï¼";
                msg.className = "mt-10 text-2xl font-bold text-center text-yellow-600 animate-bounce";
            } else if (winnerUid) {
                btn.className = "buzzer-btn w-64 h-64 rounded-full text-white text-4xl font-bold mx-auto flex items-center justify-center shadow-none bg-gray-400 cursor-not-allowed opacity-70";
                btn.innerText = "å·²è¢«æ¶èµ°";
                btn.disabled = true;
                msg.innerText = "ä¸‹æ¬¡æ‰‹è…³è¦å¿«é»å–”ï¼";
                msg.className = "mt-10 text-xl font-bold text-center text-gray-500";
            } else if (isGlobalLocked || isIndividuallyLocked) {
                btn.className = "buzzer-btn w-64 h-64 rounded-full text-white text-4xl font-bold mx-auto flex items-center justify-center shadow-[0_10px_0_rgb(153,27,27)] bg-red-600 cursor-not-allowed opacity-80";
                btn.innerText = "ğŸ”’ é–å®š";
                btn.disabled = true;
                msg.innerText = isIndividuallyLocked ? "æ‚¨ç›®å‰è¢«æš«åœæ¶ç­”" : "è«‹ç­‰å¾…è€å¸«é–‹æ”¾æ¶ç­”...";
                msg.className = "mt-10 text-xl font-bold text-center text-red-500";
            } else {
                btn.className = "buzzer-btn w-64 h-64 rounded-full text-white text-5xl font-extrabold mx-auto flex items-center justify-center shadow-[0_15px_0_rgb(21,128,61)] active:shadow-[0_0px_0_rgb(21,128,61)] active:translate-y-4 bg-green-500 hover:bg-green-400 cursor-pointer transition-all";
                btn.innerText = "æŒ‰æˆ‘ï¼";
                btn.disabled = false;
                msg.innerText = "ğŸŸ¢ æº–å‚™æ¶ç­”ï¼";
                msg.className = "mt-10 text-2xl font-bold text-center text-green-600 animate-pulse";
            }
        }

        // --- å¤§è¢å¹•å±•ç¤ºåŠŸèƒ½ ---

        async function joinAsDisplay() {
            const codeInput = document.getElementById('display-session-code').value.trim().toUpperCase();
            if (codeInput.length !== 6) return showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ 6 ç¢¼ä»£ç¢¼', 'warning');

            const sessionRef = getPublicSessionRef(codeInput);
            try {
                const docSnap = await getDoc(sessionRef);
                if (!docSnap.exists()) {
                    return showToast('æ‰¾ä¸åˆ°è©²å ´æ¬¡', 'error');
                }
                state.sessionId = codeInput;
                showView('view-display-screen');
                document.getElementById('display-room-code').innerText = codeInput;
                startSessionListeners('display');
            } catch (error) {
                console.error("Display join error", error);
            }
        }

        function renderDisplayScreen() {
            if (!state.sessionData) return;

            const winnerBanner = document.getElementById('display-winner-banner');
            const winnerNameEl = document.getElementById('display-winner-name');
            const winnerUid = state.sessionData.winnerUid;

            if (winnerUid) {
                const winnerObj = state.participants.find(p => p.uid === winnerUid);
                winnerNameEl.innerText = winnerObj ? winnerObj.name : "æœªçŸ¥åƒè³½è€…";
                winnerBanner.classList.remove('hidden');
            } else {
                winnerBanner.classList.add('hidden');
            }

            const grid = document.getElementById('display-participants-grid');
            grid.innerHTML = '';
            
            const sortedParticipants = [...state.participants].sort((a, b) => b.score - a.score);

            sortedParticipants.forEach(p => {
                const isWinner = p.uid === winnerUid;
                const cardClass = isWinner 
                    ? "bg-yellow-100 border-4 border-yellow-400 transform scale-105 shadow-xl" 
                    : "bg-white border-2 border-gray-100 shadow-md";

                const card = document.createElement('div');
                card.className = `rounded-2xl p-6 text-center transition-all duration-300 flex flex-col justify-center items-center h-40 ${cardClass}`;
                card.innerHTML = `
                    <div class="text-2xl font-bold text-gray-800 mb-2 truncate w-full">${p.name}</div>
                    <div class="text-5xl font-black text-blue-600">${p.score}</div>
                `;
                grid.appendChild(card);
            });
        }

        // --- è³‡æ–™åŒæ­¥ç›£è½å™¨ ---

        function startSessionListeners(role) {
            if (!state.sessionId) return;

            if (state.unsubSession) state.unsubSession();
            if (state.unsubParticipants) state.unsubParticipants();

            const sessionRef = getPublicSessionRef(state.sessionId);
            const participantsRef = getParticipantsCollectionRef(state.sessionId);

            state.unsubSession = onSnapshot(sessionRef, (doc) => {
                if (doc.exists()) {
                    state.sessionData = doc.data();
                    
                    if (role === 'host') {
                        updateHostUI();
                    } else if (role === 'student') {
                        updateStudentUI();
                    } else if (role === 'display') {
                        renderDisplayScreen();
                    }
                }
            }, (error) => {
                console.error("Session sync error:", error);
                showToast("é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ•´é é¢", "error");
            });

            state.unsubParticipants = onSnapshot(participantsRef, (snapshot) => {
                state.participants = [];
                snapshot.forEach((doc) => {
                    state.participants.push(doc.data());
                });
                
                if (role === 'host') {
                    renderHostParticipants();
                } else if (role === 'student') {
                    updateStudentUI();
                } else if (role === 'display') {
                    renderDisplayScreen();
                }
            }, (error) => {
                console.error("Participants sync error:", error);
            });
        }

        function updateHostUI() {
            if (!state.sessionData) return;

            const btnLock = document.getElementById('btn-toggle-lock');
            const statusBadge = document.getElementById('host-status-badge');
            const winnerAlert = document.getElementById('host-winner-alert');
            const winnerName = document.getElementById('host-winner-name');

            if (state.sessionData.isLocked) {
                btnLock.innerText = "ğŸ”“ è§£é–æ‰€æœ‰æ¶ç­”";
                btnLock.className = "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded shadow";
                statusBadge.innerText = "å·²æš«åœæ¶ç­”";
                statusBadge.className = "px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-bold";
            } else {
                btnLock.innerText = "ğŸ”’ æš«åœæ‰€æœ‰æ¶ç­”";
                btnLock.className = "w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded shadow";
                statusBadge.innerText = "é–‹æ”¾æ¶ç­”ä¸­";
                statusBadge.className = "px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold animate-pulse";
            }

            if (state.sessionData.winnerUid) {
                const winner = state.participants.find(p => p.uid === state.sessionData.winnerUid);
                winnerName.innerText = winner ? winner.name : "æœªçŸ¥";
                winnerAlert.classList.remove('hidden');
                
                renderHostParticipants();
            } else {
                winnerAlert.classList.add('hidden');
                renderHostParticipants();
            }
        }

        // --- åˆå§‹åŒ–èˆ‡æ¬Šé™é©—è­‰ ---

        async function initAuth() {
            document.getElementById('userInfo').innerText = "é©—è­‰ä¸­...";
            try {
                // å¼·åˆ¶åŸ·è¡ŒåŒ¿åç™»å…¥
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth error:", error);
                
                // è™•ç† auth/configuration-not-found éŒ¯èª¤ (æœªå•Ÿç”¨åŒ¿åç™»å…¥)
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                    document.getElementById('userInfo').innerText = "é©—è­‰å¤±æ•—ï¼šæœªå•Ÿç”¨åŒ¿åç™»å…¥";
                    const errBox = document.getElementById('auth-error-message');
                    if(errBox) errBox.classList.remove('hidden');
                    showToast('è«‹è‡³ Firebase å•Ÿç”¨åŒ¿åç™»å…¥', 'error');
                } else {
                    document.getElementById('userInfo').innerText = "é©—è­‰å¤±æ•— (è«‹ç¢ºä¿ Firebase å·²æ­£ç¢ºè¨­å®š)";
                }
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                const isAnon = user.isAnonymous ? "é€£ç·šæˆåŠŸ" : "è€å¸«";
                document.getElementById('userInfo').innerText = `${isAnon}`;
                
                // é©—è­‰æˆåŠŸæ™‚éš±è—éŒ¯èª¤æç¤º
                const errBox = document.getElementById('auth-error-message');
                if(errBox) errBox.classList.add('hidden');
                
                const urlParams = new URLSearchParams(window.location.search);
                const codeParam = urlParams.get('code');
                if (codeParam && codeParam.length === 6) {
                    document.getElementById('join-session-code').value = codeParam;
                    showView('view-student-join');
                }

            } else {
                state.user = null;
                document.getElementById('userInfo').innerText = "æœªé€£ç·š";
            }
        });

        // ç¶å®šåˆ° window ä½¿ HTML onclick å¯ä»¥å‘¼å«
        window.app = {
            showView,
            createSession,
            joinAsStudent,
            joinAsDisplay,
            toggleGlobalLock,
            resetBuzzer,
            adjustScore,
            toggleParticipantLock,
            buzzIn
        };

        // å•Ÿå‹•é©—è­‰
        initAuth();

    </script>
</body>
</html>
